<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกข้อมูล IP เครื่องสาขา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; }
        .nav-btn.active { background-color: #1d4ed8; font-weight: 600; }
        #imagePreview, #imageSample { max-height: 160px; object-fit: contain; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-center py-4 sm:py-0 sm:h-16">
                <div class="flex items-center mb-4 sm:mb-0">
                    <i class="fas fa-network-wired text-blue-600 text-2xl mr-3"></i>
                    <h1 class="text-lg sm:text-xl font-bold text-gray-800">ระบบบันทึกข้อมูล IP (มี2 เครื่องใส่เครื่องเดียวพอ) </h1>
                </div>
                <div class="flex flex-wrap items-center justify-center gap-2 sm:space-x-4">
                    <button id="nav-form" onclick="showPage('form')" class="nav-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-xl text-sm"><i class="fas fa-edit mr-2"></i>จัดการข้อมูล</button>
                    <button id="nav-list" onclick="showPage('list')" class="nav-btn bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-xl text-sm"><i class="fas fa-list mr-2"></i>รายการ</button>
                    <button id="nav-dashboard" onclick="showPage('dashboard')" class="nav-btn bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-xl text-sm"><i class="fas fa-chart-bar mr-2"></i>Dashboard</button>
                    <button id="nav-log" onclick="showPage('log')" class="nav-btn bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-xl text-sm"><i class="fas fa-history mr-2"></i>Log</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Form Page -->
    <div id="formPage" class="page-content">
        <div class="max-w-4xl mx-auto p-6">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6"><h2 class="text-2xl font-bold flex items-center"><i class="fas fa-server mr-3"></i><span id="form-title">เพิ่ม/แก้ไขข้อมูล IP</span></h2></div>
                <div class="p-6 bg-gray-50 border-b"><div class="flex justify-center items-center h-48"><img id="imageSample" src="https://lh3.googleusercontent.com/d/1MdYAe4NB6mzN9k8SWYVf5tHA6caP0603" alt="ตัวอย่าง IP Config" class="rounded-lg shadow-md"><img id="imagePreview" src="" alt="รูปที่อัปโหลด" class="hidden rounded-lg shadow-md"></div></div>
                <form id="ipForm" class="p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- *** แก้ไข: maxlength="2" และเพิ่ม placeholder *** -->
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-code text-blue-500 mr-2"></i>รหัสสาขา *</label><input type="text" id="branchCode" maxlength="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl" placeholder="เช่น A1, B2" required></div>
                        <!-- *** แก้ไข: เพิ่ม placeholder *** -->
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-building text-green-500 mr-2"></i>ชื่อสาขา *</label><input type="text" id="branchName" class="w-full px-4 py-3 border border-gray-300 rounded-xl" placeholder="เช่น สาขารามคำแหง" required></div>
                        
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-map-marker-alt text-red-500 mr-2"></i>เขต *</label><select id="district" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required><option value="">เลือกเขต</option><option value="K012">K012</option><option value="K122">K122</option><option value="K189">K189</option><option value="K195">K195</option><option value="K196">K196</option><option value="K247">K247</option><option value="K273">K273</option><option value="K358">K358</option></select></div>
                        
                        <!-- *** แก้ไข: เพิ่ม placeholder *** -->
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-globe text-purple-500 mr-2"></i>IP Address *</label><input type="text" id="ipAddress" class="w-full px-4 py-3 border border-gray-300 rounded-xl" placeholder="เช่น 192.168.1.100" required></div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-camera text-orange-500 mr-2"></i>อัปโหลดรูป IP เครื่อง (ถ้ามี)</label>
                        <div class="flex items-center gap-2">
                           <div class="flex-grow border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:border-blue-400 cursor-pointer" onclick="document.getElementById('imageUpload').click()">
                                <input type="file" id="imageUpload" accept="image/*" class="hidden">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p id="upload-text" class="text-gray-600 text-sm">คลิกเพื่อเลือกไฟล์รูปภาพ</p>
                           </div>
                           <button type="button" id="removeImageBtn" onclick="removeSelectedImage()" class="hidden bg-red-500 hover:bg-red-600 text-white rounded-xl p-4 transition-opacity">
                                <i class="fas fa-trash-alt text-3xl"></i>
                           </button>
                        </div>
                    </div>
                    <input type="hidden" id="existingImageUrl">
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 pt-6 border-t"><button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl flex items-center justify-center text-sm"><i class="fas fa-save mr-2"></i>บันทึก</button><button type="button" onclick="clearForm()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-3 rounded-xl flex items-center justify-center text-sm"><i class="fas fa-eraser mr-2"></i>ล้างฟอร์ม</button></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- List Page -->
    <div id="listPage" class="page-content hidden"><div class="max-w-7xl mx-auto p-6"><div class="bg-white rounded-2xl shadow-xl overflow-hidden"><div class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white p-6"><div class="flex flex-col sm:flex-row justify-between items-center"><h2 class="text-2xl font-bold flex items-center mb-4 sm:mb-0"><i class="fas fa-list mr-3"></i>รายการข้อมูลสาขา</h2><div class="flex gap-2"><button onclick="refreshList()" class="bg-white text-indigo-600 px-4 py-2 rounded-lg hover:bg-gray-100 text-sm"><i class="fas fa-sync-alt mr-2"></i>รีเฟรช</button><input type="text" id="searchInput" placeholder="ค้นหา..." class="px-4 py-2 rounded-lg text-gray-800 text-sm w-48" onkeyup="filterList()"></div></div></div><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">รูป</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">รหัสสาขา</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ชื่อสาขา</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP Address</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">จัดการ</th></tr></thead><tbody id="branchListBody" class="bg-white divide-y divide-gray-200"></tbody></table></div><div id="loadingState" class="p-12 text-center hidden"><i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i><p class="mt-2">กำลังโหลดข้อมูล...</p></div><div id="emptyState" class="hidden p-12 text-center"><i class="fas fa-inbox text-6xl text-gray-300"></i><h3 class="text-xl font-semibold text-gray-600 mt-4">ยังไม่มีข้อมูล</h3></div></div></div></div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page-content hidden"><div class="max-w-7xl mx-auto p-6"><div class="mb-8"><h2 class="text-3xl font-bold text-gray-800">Dashboard</h2><p class="text-gray-600">สรุปข้อมูล IP เครื่องสาขาทั้งหมด</p></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500"><div class="flex items-center justify-between"><div><p class="text-sm text-gray-600">รวมสาขาทั้งหมด</p><p class="text-3xl font-bold" id="totalBranches">0</p></div><i class="fas fa-building text-blue-500 text-3xl"></i></div></div><div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500"><div class="flex items-center justify-between"><div><p class="text-sm text-gray-600">เขตที่มีข้อมูล</p><p class="text-3xl font-bold" id="activeDistricts">0</p></div><i class="fas fa-map-marker-alt text-green-500 text-3xl"></i></div></div><div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-500"><div class="flex items-center justify-between"><div><p class="text-sm text-gray-600">IP Address</p><p class="text-3xl font-bold" id="totalIPs">0</p></div><i class="fas fa-globe text-purple-500 text-3xl"></i></div></div><div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-orange-500"><div class="flex items-center justify-between"><div><p class="text-sm text-gray-600">อัปเดตล่าสุด</p><p class="text-lg font-bold" id="lastUpdate">-</p></div><i class="fas fa-clock text-orange-500 text-3xl"></i></div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white rounded-2xl shadow-lg p-6"><h3 class="text-xl font-bold text-gray-800 mb-4">จำนวนสาขาตามเขต</h3><canvas id="districtChart"></canvas></div><div class="bg-white rounded-2xl shadow-lg p-6"><h3 class="text-xl font-bold text-gray-800 mb-4">สัดส่วนการกระจายตัว</h3><canvas id="pieChart"></canvas></div></div></div></div>

    <!-- Log Page -->
    <div id="logPage" class="page-content hidden"><div class="max-w-7xl mx-auto p-6"><div class="bg-white rounded-2xl shadow-xl overflow-hidden"><div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-6"><h2 class="text-2xl font-bold flex items-center"><i class="fas fa-history mr-3"></i>ประวัติการใช้งานระบบ (Log)</h2></div><div class="p-6 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">วันเวลา</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ผู้ใช้งาน</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">การดำเนินการ</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">รายละเอียด</th></tr></thead><tbody id="logTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div></div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw0YufM-6D2QLauIDyvpnLJeJrVI4tDjMaIjYtQ7lL9q59WyJlC7rqRzHcudU0pUlHM/exec'; 

        let currentEditId = null, allBranchData = [], filteredBranchData = [];
        let barChart, pieChart;

        // *** เพิ่ม Event Listener สำหรับ "ชื่อสาขา" ***
        document.getElementById('branchName').addEventListener('blur', (e) => {
            const value = e.target.value.trim();
            // ถ้ามีข้อความ แต่ไม่ได้ขึ้นต้นด้วย "สาขา" ให้เติมให้
            if (value && !value.startsWith('สาขา')) {
                e.target.value = 'สาขา' + value;
            }
        });

        document.getElementById('imageUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('imagePreview').src = event.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('imageSample').classList.add('hidden');
                document.getElementById('upload-text').textContent = file.name;
                document.getElementById('removeImageBtn').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        function removeSelectedImage() {
            document.getElementById('imageUpload').value = '';
            document.getElementById('imagePreview').src = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imageSample').classList.remove('hidden');
            document.getElementById('upload-text').textContent = 'คลิกเพื่อเลือกไฟล์รูปภาพ';
            document.getElementById('removeImageBtn').classList.add('hidden');
            
            const existingUrl = document.getElementById('existingImageUrl').value;
            if (existingUrl) {
                document.getElementById('imagePreview').src = existingUrl;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('imageSample').classList.add('hidden');
            }
        }
        
        function makeJSONPRequest(params, callback) {
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = (data) => { delete window[callbackName]; document.body.removeChild(script); callback(data); };
            const script = document.createElement('script');
            const queryString = Object.keys(params).map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`).join('&');
            script.src = `${APPS_SCRIPT_URL}?${queryString}&callback=${callbackName}`;
            document.body.appendChild(script);
        }

        function showPage(pageName) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`${pageName}Page`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${pageName}`).classList.add('active');
            if (pageName === 'form') clearForm();
            else if (pageName === 'list') loadAllBranchData();
            else if (pageName === 'dashboard') loadDashboardData();
            else if (pageName === 'log') loadLogData();
        }

        document.getElementById('ipForm').addEventListener('submit', (e) => { e.preventDefault(); saveData(); });

        function clearForm() {
            document.getElementById('ipForm').reset();
            document.getElementById('branchCode').disabled = false;
            document.getElementById('form-title').textContent = 'เพิ่ม/แก้ไขข้อมูล IP';
            document.getElementById('imagePreview').src = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imageSample').classList.remove('hidden');
            document.getElementById('upload-text').textContent = 'คลิกเพื่อเลือกไฟล์รูปภาพ';
            document.getElementById('existingImageUrl').value = '';
            document.getElementById('removeImageBtn').classList.add('hidden');
            currentEditId = null;
        }

        function saveData() {
            const file = document.getElementById('imageUpload').files[0];
            const formData = {
                action: 'save', branchCode: document.getElementById('branchCode').value, branchName: document.getElementById('branchName').value,
                district: document.getElementById('district').value, ipAddress: document.getElementById('ipAddress').value,
                id: currentEditId, existingImageUrl: document.getElementById('existingImageUrl').value };
            if (!formData.branchCode || !formData.branchName || !formData.district || !formData.ipAddress) {
                Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูลให้ครบทุกช่อง', 'error'); return;
            }
            Swal.fire({ title: 'กำลังบันทึก...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    formData.fileData = e.target.result.split(',')[1];
                    formData.fileName = file.name;
                    formData.mimeType = file.type;
                    postDataToServer(formData);
                };
                reader.readAsDataURL(file);
            } else { postDataToServer(formData); }
        }

        async function postDataToServer(data) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
                const result = await response.json();
                if (result.success) {
                    Swal.fire('สำเร็จ!', result.message, 'success');
                    clearForm();
                } else {
                    Swal.fire('เกิดข้อผิดพลาด!', result.message, 'error');
                }
            } catch (error) { Swal.fire('การเชื่อมต่อล้มเหลว', error.toString(), 'error'); }
        }
        
        function loadAllBranchData() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('branchListBody').innerHTML = '';
            makeJSONPRequest({ action: 'getAllData' }, (response) => {
                document.getElementById('loadingState').classList.add('hidden');
                if (response.success) {
                    allBranchData = response.data || [];
                    filteredBranchData = [...allBranchData];
                    updateBranchList();
                } else { document.getElementById('emptyState').classList.remove('hidden'); }
            });
        }

        function updateBranchList() {
            const tbody = document.getElementById('branchListBody');
            tbody.innerHTML = '';
            if (filteredBranchData.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden'); return;
            }
            document.getElementById('emptyState').classList.add('hidden');
            filteredBranchData.forEach(branch => {
                const imageUrl = branch.imageUrl || 'https://via.placeholder.com/40x40.png?text=No+Img';
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-2 text-center"><a href="${branch.imageUrl}" target="_blank" rel="noopener noreferrer"><img src="${imageUrl}" class="w-10 h-10 object-cover rounded-md inline-block"></a></td>
                        <td class="px-6 py-2"><span class="font-medium">${branch.branchCode}</span></td>
                        <td class="px-6 py-2">${branch.branchName}</td>
                        <td class="px-6 py-2 font-mono">${branch.ipAddress}</td>
                        <td class="px-6 py-2 text-center">
                            <div class="flex justify-center space-x-2">
                                <button onclick='editBranchFromList(${JSON.stringify(branch)})' class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs">แก้ไข</button>
                                <button onclick="deleteBranchFromList('${branch.branchCode}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs">ลบ</button>
                            </div>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }
        
        function editBranchFromList(branch) {
            clearForm();
            document.getElementById('branchCode').value = branch.branchCode;
            document.getElementById('branchName').value = branch.branchName;
            document.getElementById('district').value = branch.district;
            document.getElementById('ipAddress').value = branch.ipAddress;
            document.getElementById('existingImageUrl').value = branch.imageUrl || '';
            currentEditId = branch.id;
            if (branch.imageUrl) {
                document.getElementById('imagePreview').src = branch.imageUrl;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('imageSample').classList.add('hidden');
                document.getElementById('removeImageBtn').classList.remove('hidden');
            }
            document.getElementById('branchCode').disabled = true;
            document.getElementById('form-title').textContent = `แก้ไขข้อมูลสาขา: ${branch.branchCode}`;
            showPage('form');
        }

        function deleteBranchFromList(branchCode) {
            Swal.fire({
                title: `ต้องการลบสาขา ${branchCode}?`, text: "การกระทำนี้ไม่สามารถย้อนกลับได้!", icon: 'warning',
                input: 'password', inputPlaceholder: 'กรอกรหัสผ่านเพื่อยืนยัน',
                showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'ยืนยันการลบ', cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (!result.isConfirmed) return;
                Swal.fire({ title: 'กำลังลบ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                makeJSONPRequest({ action: 'delete', branchCode, password: result.value }, (response) => {
                    if (response.success) {
                        Swal.fire('ลบสำเร็จ!', response.message, 'success');
                        refreshList();
                    } else { Swal.fire('เกิดข้อผิดพลาด!', response.message, 'error'); }
                });
            });
        }

        function loadDashboardData() {
            makeJSONPRequest({ action: 'getDashboardData' }, (response) => {
                if (!response.success) return;
                const { data } = response;
                document.getElementById('totalBranches').textContent = data.totalBranches;
                document.getElementById('activeDistricts').textContent = data.activeDistricts;
                document.getElementById('totalIPs').textContent = data.totalIPs;
                document.getElementById('lastUpdate').textContent = data.lastUpdate;
                if (barChart) barChart.destroy();
                if (pieChart) pieChart.destroy();
                const barCtx = document.getElementById('districtChart').getContext('2d');
                barChart = new Chart(barCtx, { type: 'bar', data: data.chartData, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
                const pieCtx = document.getElementById('pieChart').getContext('2d');
                pieChart = new Chart(pieCtx, { type: 'doughnut', data: data.chartData, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
            });
        }

        function loadLogData() {
            makeJSONPRequest({ action: 'getLogData' }, (response) => {
                const tbody = document.getElementById('logTableBody');
                tbody.innerHTML = '';
                if (!response.success || response.data.length === 0) return;
                response.data.forEach(log => {
                    const badgeClass = log.action.includes('เพิ่ม') ? 'bg-green-100 text-green-800' : log.action.includes('แก้ไข') ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800';
                    tbody.innerHTML += `<tr><td class="px-6 py-4 text-sm">${log.timestamp}</td><td class="px-6 py-4 text-sm">${log.user}</td><td class="px-6 py-4"><span class="px-2 inline-flex text-xs font-semibold rounded-full ${badgeClass}">${log.action}</span></td><td class="px-6 py-4 text-sm">${log.details}</td></tr>`;
                });
            });
        }

        function filterList() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            filteredBranchData = allBranchData.filter(b => Object.values(b).some(v => String(v).toLowerCase().includes(term)));
            updateBranchList();
        }
        function refreshList() { document.getElementById('searchInput').value = ''; loadAllBranchData(); }
        document.addEventListener('DOMContentLoaded', () => showPage('form'));
    </script>
</body>
</html>



