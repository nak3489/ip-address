<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .file-upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .file-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        .file-upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</h1>
            <p class="text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
            <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg inline-block">
                <p class="text-green-700 text-sm font-medium">
                    üîí ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô
                </p>
            </div>
        </div>

        <!-- Example Image Card -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="mr-2">üìã</span> ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ IP Address ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            </h2>
            <div class="bg-gray-50 rounded-lg p-4 border-2 border-dashed border-gray-300">
                <div class="text-center">
                    <div id="exampleImageContainer">
                        <!-- ‚≠ê ‡πÉ‡∏™‡πà URL ‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á IP Address ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á src="" -->
                        <!-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: src="https://example.com/ip-example.jpg" -->
                        <img id="exampleImage" class="mx-auto max-w-full max-h-64 rounded-lg shadow-md mb-4" 
                             src="" alt="‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á IP Address"
                             onerror="this.style.display='none'; document.getElementById('imageError').style.display='block';">
                        <div id="imageError" class="hidden text-red-500 text-sm mb-4">
                            ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">
                        <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á IP Address ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ipconfig ‡∏´‡∏£‡∏∑‡∏≠ Network Settings
                    </p>
                </div>
            </div>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <form id="branchForm" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üè¢ ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="branchCode" required maxlength="2" pattern="[A-Za-z‡∏Å-‡∏Æ0-9]{2}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                               placeholder="‡πÄ‡∏ä‡πà‡∏ô A1, B2, ‡∏Å1">
                        <p class="text-xs text-gray-500 mt-1">2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£: A-Z, ‡∏Å-‡∏Æ, 0-9</p>
                    </div>

                    <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üè™ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ <span class="text-red-500">*</span>
                        </label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border border-r-0 border-gray-300 rounded-l-lg">
                                ‡∏™‡∏≤‡∏Ç‡∏≤
                            </span>
                            <input type="text" id="branchName" required
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏µ‡∏•‡∏°, ‡∏ö‡∏≤‡∏á‡∏ô‡∏≤, ‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•">
                        </div>
                    </div>

                    <!-- ‡πÄ‡∏Ç‡∏ï -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üìç ‡πÄ‡∏Ç‡∏ï <span class="text-red-500">*</span>
                        </label>
                        <select id="district" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï</option>
                            <option value="K012">K012</option>
                            <option value="K122">K122</option>
                            <option value="K189">K189</option>
                            <option value="K195">K195</option>
                            <option value="K196">K196</option>
                            <option value="K247">K247</option>
                            <option value="K273">K273</option>
                            <option value="K358">K358</option>
                        </select>
                    </div>

                    <!-- IP Address -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üíª IP Address (‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå) <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="ipAddress" required pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                               placeholder="‡πÄ‡∏ä‡πà‡∏ô 192.168.1.100">
                        <p class="text-xs text-gray-500 mt-1">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: xxx.xxx.xxx.xxx</p>
                    </div>
                </div>

                <!-- ‡∏£‡∏π‡∏õ IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        üì∏ ‡∏£‡∏π‡∏õ IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á <span class="text-red-500">*</span>
                    </label>
                    <div class="file-upload-area rounded-lg p-6 text-center cursor-pointer" id="uploadArea">
                        <input type="file" id="imageFile" accept="image/*" class="hidden" required>
                        <div id="uploadContent">
                            <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <p class="text-gray-600 mb-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                            <p class="text-xs text-gray-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: JPG, PNG, GIF (‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)</p>
                        </div>
                        <div id="imagePreview" class="hidden">
                            <img id="previewImg" class="mx-auto max-w-xs max-h-48 rounded-lg shadow-md mb-2">
                            <p id="fileName" class="text-sm text-gray-600 mb-2"></p>
                            <button type="button" id="removeImage" class="text-red-500 hover:text-red-700 text-sm">
                                üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-center pt-4">
                    <button type="submit" 
                            class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold px-8 py-3 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </form>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-2xl shadow-xl mb-6">
            <div class="flex border-b">
                <button id="dashboardTab" class="flex-1 py-4 px-6 text-center font-semibold text-blue-600 border-b-2 border-blue-600 bg-blue-50">
                    üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                </button>
                <button id="dataTab" class="flex-1 py-4 px-6 text-center font-semibold text-gray-600 hover:text-blue-600 hover:bg-gray-50">
                    üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                </button>
                <button id="logTab" class="flex-1 py-4 px-6 text-center font-semibold text-gray-600 hover:text-blue-600 hover:bg-gray-50">
                    üìù Log ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="space-y-6">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p id="totalBranches" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-blue-400 bg-opacity-30 rounded-full p-3">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-2xl p-6 text-white shadow-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm font-medium">‡πÄ‡∏Ç‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p id="totalDistricts" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-green-400 bg-opacity-30 rounded-full p-3">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm font-medium">IP Address</p>
                            <p id="totalIPs" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-purple-400 bg-opacity-30 rounded-full p-3">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-2xl p-6 text-white shadow-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-100 text-sm font-medium">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                            <p id="totalImages" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-orange-400 bg-opacity-30 rounded-full p-3">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- District Summary -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">üìç ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏Ç‡∏ï</h2>
                    <button id="downloadDistrictBtn" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-2 rounded-lg shadow-md transform hover:scale-105 transition-all duration-200">
                        üì• Download ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ç‡∏ï
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡πÄ‡∏Ç‡∏ï</th>
                                <th class="border border-gray-200 px-4 py-3 text-center font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                <th class="border border-gray-200 px-4 py-3 text-center font-semibold text-gray-700">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th>
                            </tr>
                        </thead>
                        <tbody id="districtSummaryTable">
                            <!-- District summary will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noDistrictData" class="text-center py-8 text-gray-500">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- District Chart -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡∏ï</h3>
                    <div id="districtChart" class="h-64 flex items-center justify-center">
                        <canvas id="districtCanvas" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üïí ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                    <div id="recentActivity" class="space-y-3 max-h-64 overflow-y-auto">
                        <!-- Recent activities will be inserted here -->
                    </div>
                    <div id="noRecentActivity" class="text-center py-8 text-gray-500">
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div id="dataSection" class="bg-white rounded-2xl shadow-xl p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</h2>
                <div class="flex gap-3">
                    <button onclick="syncWithGoogleSheets()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg shadow-md transform hover:scale-105 transition-all duration-200">
                        üîÑ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button onclick="recoverData()" 
                            class="bg-orange-600 hover:bg-orange-700 text-white font-semibold px-4 py-2 rounded-lg shadow-md transform hover:scale-105 transition-all duration-200">
                        üì• ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button id="downloadBtn" 
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-2 rounded-lg shadow-md transform hover:scale-105 transition-all duration-200">
                        üì• Download Excel
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡πÄ‡∏Ç‡∏ï</th>
                            <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">IP Address</th>
                            <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡∏£‡∏π‡∏õ IP</th>
                            <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                            <th class="border border-gray-200 px-4 py-3 text-center font-semibold text-gray-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div id="noData" class="text-center py-8 text-gray-500">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </div>
        </div>

        <!-- Log Section -->
        <div id="logSection" class="bg-white rounded-2xl shadow-xl p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">üìù Log ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h2>
                <button id="downloadLogBtn" 
                        class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-2 rounded-lg shadow-md transform hover:scale-105 transition-all duration-200">
                    üì• Download Log Excel
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                            <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
                            <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                        </tr>
                    </thead>
                    <tbody id="logTable">
                        <!-- Log data will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div id="noLog" class="text-center py-8 text-gray-500">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Log ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤</h3>
                <button id="closeEditModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <form id="editForm" class="space-y-6">
                <input type="hidden" id="editIndex">
                
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üè¢ ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="editBranchCode" required maxlength="2" pattern="[A-Za-z‡∏Å-‡∏Æ0-9]{2}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        <p class="text-xs text-gray-500 mt-1">2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£: A-Z, ‡∏Å-‡∏Æ, 0-9</p>
                    </div>

                    <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üè™ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ <span class="text-red-500">*</span>
                        </label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border border-r-0 border-gray-300 rounded-l-lg">
                                ‡∏™‡∏≤‡∏Ç‡∏≤
                            </span>
                            <input type="text" id="editBranchName" required
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>
                    </div>

                    <!-- ‡πÄ‡∏Ç‡∏ï -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üìç ‡πÄ‡∏Ç‡∏ï <span class="text-red-500">*</span>
                        </label>
                        <select id="editDistrict" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï</option>
                            <option value="K012">K012</option>
                            <option value="K122">K122</option>
                            <option value="K189">K189</option>
                            <option value="K195">K195</option>
                            <option value="K196">K196</option>
                            <option value="K247">K247</option>
                            <option value="K273">K273</option>
                            <option value="K358">K358</option>
                        </select>
                    </div>

                    <!-- IP Address -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üíª IP Address (‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå) <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="editIpAddress" required pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        <p class="text-xs text-gray-500 mt-1">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: xxx.xxx.xxx.xxx</p>
                    </div>
                </div>

                <!-- ‡∏£‡∏π‡∏õ IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        üì∏ ‡∏£‡∏π‡∏õ IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
                    </label>
                    <div class="mb-4">
                        <img id="currentImage" class="max-w-xs max-h-48 rounded-lg shadow-md">
                        <p class="text-sm text-gray-600 mt-2">‡∏£‡∏π‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                    </div>
                    <div class="file-upload-area rounded-lg p-6 text-center cursor-pointer" id="editUploadArea">
                        <input type="file" id="editImageFile" accept="image/*" class="hidden">
                        <div id="editUploadContent">
                            <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <p class="text-gray-600 mb-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</p>
                            <p class="text-xs text-gray-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: JPG, PNG, GIF (‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)</p>
                        </div>
                        <div id="editImagePreview" class="hidden">
                            <img id="editPreviewImg" class="mx-auto max-w-xs max-h-48 rounded-lg shadow-md mb-2">
                            <p id="editFileName" class="text-sm text-gray-600 mb-2"></p>
                            <button type="button" id="removeEditImage" class="text-red-500 hover:text-red-700 text-sm">
                                üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-center gap-4 pt-4">
                    <button type="button" id="cancelEdit" 
                            class="bg-gray-500 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded-lg transition-all duration-200">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" 
                            class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-semibold px-8 py-3 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Google Sheets Database System with JSONP & POST
        let savedData = [];
        let logData = [];
        
        // ‚≠ê ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwxe3wQrNOCHpphITJ37WItvaZWV0bthnnKc6qwt0pLlkKUnoet1h9qrNM2RPVXF3UtSA/exec';
        
        // JSONP Helper Functions for GET requests
        function makeJSONPRequest(url, callback, errorCallback) {
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            const script = document.createElement('script');
            
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(data);
            };
            
            script.onerror = function() {
                delete window[callbackName];
                document.body.removeChild(script);
                if (errorCallback) errorCallback(new Error('JSONP request failed'));
            };
            
            script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
            document.body.appendChild(script);
            
            setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    if (errorCallback) errorCallback(new Error('JSONP request timeout'));
                }
            }, 30000);
        }
        
        // Initialize data storage from Google Sheets using JSONP
        function initializeDataStorage() {
            showLoadingMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            makeJSONPRequest(
                `${GOOGLE_SCRIPT_URL}?action=getData`,
                function(result) {
                    try {
                        if (result.success) {
                            savedData = result.branchData || [];
                            logData = result.logData || [];
                            displayData();
                            displayLogData();
                            updateDashboard();
                            hideLoadingMessage();
                            console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        } else {
                            throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                        }
                    } catch (error) {
                        handleLoadError(error);
                    }
                },
                function(error) {
                    handleLoadError(error);
                }
            );
        }
        
        function handleLoadError(error) {
            console.warn('Error loading from Google Sheets:', error);
            hideLoadingMessage();
            
            // Fallback to localStorage
            try {
                const localData = localStorage.getItem('branchData_backup');
                const localLog = localStorage.getItem('logData_backup');
                
                if (localData) savedData = JSON.parse(localData);
                if (localLog) logData = JSON.parse(localLog);
                
                if (savedData.length > 0 || logData.length > 0) {
                    alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡πÑ‡∏î‡πâ\n‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ó‡∏ô');
                }
            } catch (e) {
                console.warn('Fallback failed:', e);
            }
            
            displayData();
            displayLogData();
            updateDashboard();
        }
        
        // Save data to Google Sheets using POST via fetch API
        async function saveDataPersistent() {
            showLoadingMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets...');

            const postData = {
                action: 'saveData',
                branchData: savedData,
                logData: logData
            };

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData),
                });

                if (!response.ok) {
                   throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                
                const result = await response.json();

                if (result.success) {
                    localStorage.setItem('branchData_backup', JSON.stringify(savedData));
                    localStorage.setItem('logData_backup', JSON.stringify(logData));
                    hideLoadingMessage();
                    console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (POST)');
                } else {
                    throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                handleSaveError(error);
            }
        }
        
        function handleSaveError(error) {
            console.error('Error saving to Google Sheets:', error);
            hideLoadingMessage();
            
            try {
                localStorage.setItem('branchData_backup', JSON.stringify(savedData));
                localStorage.setItem('logData_backup', JSON.stringify(logData));
                alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Google Sheets ‡πÑ‡∏î‡πâ\n‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ó‡∏ô');
            } catch (e) {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }
        
        // Sync data with Google Sheets using JSONP
        function syncWithGoogleSheets() {
            showLoadingMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            makeJSONPRequest(
                `${GOOGLE_SCRIPT_URL}?action=syncData`,
                function(result) {
                    try {
                        if (result.success) {
                            const hasChanges = JSON.stringify(savedData) !== JSON.stringify(result.branchData) ||
                                             JSON.stringify(logData) !== JSON.stringify(result.logData);
                            
                            if (hasChanges) {
                                savedData = result.branchData || [];
                                logData = result.logData || [];
                                
                                displayData();
                                displayLogData();
                                updateDashboard();
                                
                                alert('üîÑ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà');
                            } else {
                                alert('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á');
                            }
                        }
                        
                        hideLoadingMessage();
                    } catch (error) {
                        handleSyncError(error);
                    }
                },
                function(error) {
                    handleSyncError(error);
                }
            );
        }
        
        function handleSyncError(error) {
            console.warn('Sync failed:', error);
            hideLoadingMessage();
            alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
        }
        
        // Loading message functions
        function showLoadingMessage(message) {
            const existingLoader = document.getElementById('loadingMessage');
            if (existingLoader) existingLoader.remove();
            
            const loader = document.createElement('div');
            loader.id = 'loadingMessage';
            loader.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
            loader.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ${message}
            `;
            document.body.appendChild(loader);
        }
        
        function hideLoadingMessage() {
            const loader = document.getElementById('loadingMessage');
            if (loader) loader.remove();
        }
        
        // Data recovery function using JSONP
        function recoverData() {
            const confirmed = confirm('üîÑ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
            if (!confirmed) return;
            
            showLoadingMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            makeJSONPRequest(
                `${GOOGLE_SCRIPT_URL}?action=recoverData`,
                function(result) {
                    try {
                        if (result.success && result.branchData) { // Check for branchData, not backupData
                            savedData = result.branchData || [];
                            logData = result.logData || [];
                            
                            displayData();
                            displayLogData();
                            updateDashboard();
                            
                            hideLoadingMessage();
                            alert('‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
                        } else {
                            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á');
                        }
                    } catch (error) {
                        handleRecoverError(error);
                    }
                },
                function(error) {
                    handleRecoverError(error);
                }
            );
        }
        
        function handleRecoverError(error) {
            console.warn('Recovery failed:', error);
            hideLoadingMessage();
            alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
        }
        
        // Initialize on page load
        initializeDataStorage();

        // --- All other JavaScript functions (file upload, display, edit, delete, etc.) remain unchanged ---
        // --- They are included below for completeness ---

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('imageFile');
        const uploadContent = document.getElementById('uploadContent');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const fileName = document.getElementById('fileName');
        const removeImageBtn = document.getElementById('removeImage');

        uploadArea.addEventListener('click', () => {
            if (!imagePreview.classList.contains('hidden')) return;
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                fileName.textContent = file.name;
                uploadContent.classList.add('hidden');
                imagePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        removeImageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.value = '';
            uploadContent.classList.remove('hidden');
            imagePreview.classList.add('hidden');
        });

        function displayData() {
            const tableBody = document.getElementById('dataTable');
            const noDataDiv = document.getElementById('noData');
            
            if (savedData.length === 0) {
                tableBody.innerHTML = '';
                noDataDiv.style.display = 'block';
                return;
            }
            
            noDataDiv.style.display = 'none';
            tableBody.innerHTML = savedData.map((item, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-3">${item.branchCode}</td>
                    <td class="border border-gray-200 px-4 py-3">${item.branchName}</td>
                    <td class="border border-gray-200 px-4 py-3">${item.district}</td>
                    <td class="border border-gray-200 px-4 py-3 font-mono">${item.ipAddress}</td>
                    <td class="border border-gray-200 px-4 py-3">
                        <button onclick="viewImage('${item.imageData}')" 
                                class="text-blue-600 hover:text-blue-800 underline">‡∏î‡∏π‡∏£‡∏π‡∏õ</button>
                    </td>
                    <td class="border border-gray-200 px-4 py-3">${item.timestamp}</td>
                    <td class="border border-gray-200 px-4 py-3 text-center">
                        <button onclick="editData(${index})" 
                                class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm mr-2">
                            ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button onclick="deleteData(${index})" 
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                            üóëÔ∏è ‡∏•‡∏ö
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function displayLogData() {
            const logTableBody = document.getElementById('logTable');
            const noLogDiv = document.getElementById('noLog');
            
            if (logData.length === 0) {
                logTableBody.innerHTML = '';
                noLogDiv.style.display = 'block';
                return;
            }
            
            noLogDiv.style.display = 'none';
            logTableBody.innerHTML = logData.map(log => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-3">${log.timestamp}</td>
                    <td class="border border-gray-200 px-4 py-3">${log.user}</td>
                    <td class="border border-gray-200 px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${log.action === '‡πÄ‡∏û‡∏¥‡πà‡∏°' ? 'bg-green-100 text-green-800' : log.action === '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${log.action}
                        </span>
                    </td>
                    <td class="border border-gray-200 px-4 py-3">${log.branchCode}</td>
                    <td class="border border-gray-200 px-4 py-3 text-sm">${log.details}</td>
                </tr>
            `).reverse().join('');
        }

        function addLog(action, branchCode, branchName, details) {
            const user = `${branchCode}-${branchName.replace('‡∏™‡∏≤‡∏Ç‡∏≤', '')}`;
            const logEntry = {
                timestamp: new Date().toLocaleString('th-TH'),
                user: user,
                action: action,
                branchCode: branchCode,
                details: details
            };
            
            logData.push(logEntry);
            saveDataPersistent();
        }

        function viewImage(imageData) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-4 max-w-2xl max-h-[90vh] overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">‡∏£‡∏π‡∏õ IP Address</h3>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                    </div>
                    <img src="${imageData}" class="max-w-full h-auto rounded-lg">
                </div>
            `;
            document.body.appendChild(modal);
        }

        document.getElementById('branchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!fileInput.files[0]) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ IP Address');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const formData = {
                    branchCode: document.getElementById('branchCode').value,
                    branchName: '‡∏™‡∏≤‡∏Ç‡∏≤' + document.getElementById('branchName').value,
                    district: document.getElementById('district').value,
                    ipAddress: document.getElementById('ipAddress').value,
                    imageData: e.target.result,
                    imageName: fileInput.files[0].name,
                    timestamp: new Date().toLocaleString('th-TH')
                };
                
                const branchCodePattern = /^[A-Za-z‡∏Å-‡∏Æ0-9]{2}$/;
                if (!branchCodePattern.test(formData.branchCode)) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ (A-Z, ‡∏Å-‡∏Æ, 0-9)');
                    return;
                }
                
                const ipPattern = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
                if (!ipPattern.test(formData.ipAddress)) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å IP Address ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 192.168.1.100)');
                    return;
                }
                
                if (savedData.some(item => item.branchCode === formData.branchCode)) {
                    alert('‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô');
                    return;
                }
                
                savedData.push(formData);
                saveDataPersistent();
                
                addLog('‡πÄ‡∏û‡∏¥‡πà‡∏°', formData.branchCode, formData.branchName, `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà IP: ${formData.ipAddress}, ‡πÄ‡∏Ç‡∏ï: ${formData.district}`);
                
                document.getElementById('branchForm').reset();
                fileInput.value = '';
                uploadContent.classList.remove('hidden');
                imagePreview.classList.add('hidden');
                displayData();
                displayLogData();
                updateDashboard();
                
                alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
            };
            reader.readAsDataURL(fileInput.files[0]);
        });

        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (savedData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
                return;
            }
            
            const password = prompt('üîê ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel:');
            
            if (password !== '348900Ty') {
                if (password !== null) {
                    alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ');
                }
                return;
            }
            
            const excelData = savedData.map(item => ({
                '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤': item.branchCode,
                '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤': item.branchName,
                '‡πÄ‡∏Ç‡∏ï': item.district,
                'IP Address': item.ipAddress,
                '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ': item.imageName,
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å': item.timestamp
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            ws['!cols'] = [
                { width: 15 }, { width: 25 }, { width: 20 },
                { width: 18 }, { width: 25 }, { width: 20 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP ‡∏™‡∏≤‡∏Ç‡∏≤');
            
            const now = new Date();
            const filename = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•_IP_‡∏™‡∏≤‡∏Ç‡∏≤_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            
            alert('‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
        });

        function updateDashboard() {
            document.getElementById('totalBranches').textContent = savedData.length;
            const uniqueDistricts = [...new Set(savedData.map(item => item.district))];
            document.getElementById('totalDistricts').textContent = uniqueDistricts.length;
            document.getElementById('totalIPs').textContent = savedData.length;
            document.getElementById('totalImages').textContent = savedData.length;
            
            displayDistrictSummary();
            drawDistrictChart();
            displayRecentActivity();
        }

        function displayDistrictSummary() {
            const districtSummaryTable = document.getElementById('districtSummaryTable');
            const noDistrictData = document.getElementById('noDistrictData');
            
            if (savedData.length === 0) {
                districtSummaryTable.innerHTML = '';
                noDistrictData.style.display = 'block';
                return;
            }
            
            noDistrictData.style.display = 'none';
            
            const districtGroups = {};
            savedData.forEach(item => {
                if (!districtGroups[item.district]) {
                    districtGroups[item.district] = [];
                }
                districtGroups[item.district].push(item);
            });
            
            const sortedDistricts = Object.keys(districtGroups).sort();
            
            districtSummaryTable.innerHTML = sortedDistricts.map(district => {
                const branches = districtGroups[district];
                const percentage = ((branches.length / savedData.length) * 100).toFixed(1);
                const branchNames = branches.map(b => `${b.branchCode} (${b.branchName})`).join(', ');
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3 font-semibold text-blue-600">${district}</td>
                        <td class="border border-gray-200 px-4 py-3 text-center">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-semibold">${branches.length}</span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3 text-sm">${branchNames}</td>
                        <td class="border border-gray-200 px-4 py-3 text-center">
                            <div class="flex items-center justify-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-sm font-semibold">${percentage}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function drawDistrictChart() {
            const canvas = document.getElementById('districtCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (savedData.length === 0) {
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px Sarabun';
                ctx.textAlign = 'center';
                ctx.fillText('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const districtGroups = {};
            savedData.forEach(item => {
                districtGroups[item.district] = (districtGroups[item.district] || 0) + 1;
            });
            
            const districts = Object.keys(districtGroups).sort();
            const counts = districts.map(d => districtGroups[d]);
            const maxCount = Math.max(...counts);
            
            const padding = 40;
            const chartWidth = canvas.width - (padding * 2);
            const chartHeight = canvas.height - (padding * 2);
            const barWidth = chartWidth / districts.length;
            
            const colors = ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#EF4444', '#06B6D4', '#84CC16', '#F97316'];
            
            districts.forEach((district, index) => {
                const barHeight = (counts[index] / maxCount) * chartHeight;
                const x = padding + (index * barWidth) + (barWidth * 0.1);
                const y = canvas.height - padding - barHeight;
                const width = barWidth * 0.8;
                
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, width, barHeight);
                
                ctx.fillStyle = '#374151';
                ctx.font = '12px Sarabun';
                ctx.textAlign = 'center';
                ctx.fillText(district, x + width/2, canvas.height - padding + 15);
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 14px Sarabun';
                ctx.fillText(counts[index], x + width/2, y + barHeight/2 + 5);
            });
            
            ctx.fillStyle = '#1F2937';
            ctx.font = 'bold 14px Sarabun';
            ctx.textAlign = 'center';
            ctx.fillText('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ç‡∏ï', canvas.width / 2, 20);
        }

        function displayRecentActivity() {
            const recentActivity = document.getElementById('recentActivity');
            const noRecentActivity = document.getElementById('noRecentActivity');
            
            if (logData.length === 0) {
                recentActivity.innerHTML = '';
                noRecentActivity.style.display = 'block';
                return;
            }
            
            noRecentActivity.style.display = 'none';
            
            const recentLogs = logData.slice(-5).reverse();
            
            recentActivity.innerHTML = recentLogs.map(log => {
                const actionColor = log.action === '‡πÄ‡∏û‡∏¥‡πà‡∏°' ? 'text-green-600 bg-green-100' : 
                                  log.action === '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' ? 'text-yellow-600 bg-yellow-100' : 
                                  'text-red-600 bg-red-100';
                
                return `
                    <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                        <div class="flex-shrink-0">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${actionColor}">${log.action}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900">${log.branchCode} - ${log.user}</p>
                            <p class="text-xs text-gray-500 truncate">${log.details}</p>
                            <p class="text-xs text-gray-400">${log.timestamp}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('downloadDistrictBtn').addEventListener('click', function() {
            if (savedData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
                return;
            }
            
            const password = prompt('üîê ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ç‡∏ï:');
            
            if (password !== '348900Ty') {
                if (password !== null) {
                    alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ');
                }
                return;
            }
            
            const districtGroups = {};
            savedData.forEach(item => {
                if (!districtGroups[item.district]) {
                    districtGroups[item.district] = [];
                }
                districtGroups[item.district].push(item);
            });
            
            const summaryData = Object.keys(districtGroups).sort().map(district => {
                const branches = districtGroups[district];
                const percentage = ((branches.length / savedData.length) * 100).toFixed(1);
                const branchList = branches.map(b => `${b.branchCode} (${b.branchName})`).join(', ');
                
                return {
                    '‡πÄ‡∏Ç‡∏ï': district,
                    '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤': branches.length,
                    '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå': percentage + '%',
                    '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤': branchList
                };
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(summaryData);
            
            ws['!cols'] = [
                { width: 15 }, { width: 15 },
                { width: 12 }, { width: 60 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏Ç‡∏ï');
            
            const now = new Date();
            const filename = `‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏Ç‡∏ï_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            
            alert('‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ç‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
        });
        
        // Tab switching logic...
        const tabs = ['dashboardTab', 'dataTab', 'logTab'];
        const sections = ['dashboardSection', 'dataSection', 'logSection'];

        tabs.forEach((tabId, index) => {
            document.getElementById(tabId).addEventListener('click', function() {
                // Update tab styles
                tabs.forEach(t => {
                    document.getElementById(t).classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
                    document.getElementById(t).classList.add('text-gray-600');
                });
                this.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
                this.classList.remove('text-gray-600');

                // Update section visibility
                sections.forEach((sectionId, secIndex) => {
                    if (index === secIndex) {
                        document.getElementById(sectionId).classList.remove('hidden');
                    } else {
                        document.getElementById(sectionId).classList.add('hidden');
                    }
                });

                // Update content if needed
                if (tabId === 'dashboardTab') updateDashboard();
                if (tabId === 'dataTab') displayData();
                if (tabId === 'logTab') displayLogData();
            });
        });

        // Edit/Delete logic... (and other functions not directly related to data saving)
        // This part remains the same as in your original script.
        function editData(index) {
            const item = savedData[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('editBranchCode').value = item.branchCode;
            document.getElementById('editBranchName').value = item.branchName.replace('‡∏™‡∏≤‡∏Ç‡∏≤', '');
            document.getElementById('editDistrict').value = item.district;
            document.getElementById('editIpAddress').value = item.ipAddress;
            document.getElementById('currentImage').src = item.imageData;
            document.getElementById('editModal').classList.remove('hidden');
        }

        document.getElementById('closeEditModal').addEventListener('click', () => document.getElementById('editModal').classList.add('hidden'));
        document.getElementById('cancelEdit').addEventListener('click', () => document.getElementById('editModal').classList.add('hidden'));

        const editUploadArea = document.getElementById('editUploadArea');
        const editFileInput = document.getElementById('editImageFile');
        const editUploadContent = document.getElementById('editUploadContent');
        const editImagePreview = document.getElementById('editImagePreview');
        const editPreviewImg = document.getElementById('editPreviewImg');
        const editFileName = document.getElementById('editFileName');
        const removeEditImageBtn = document.getElementById('removeEditImage');

        editUploadArea.addEventListener('click', () => {
            if (!editImagePreview.classList.contains('hidden')) return;
            editFileInput.click();
        });

        editFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleEditFile(e.target.files[0]);
            }
        });

        function handleEditFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                editPreviewImg.src = e.target.result;
                editFileName.textContent = file.name;
                editUploadContent.classList.add('hidden');
                editImagePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        removeEditImageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            editFileInput.value = '';
            editUploadContent.classList.remove('hidden');
            editImagePreview.classList.add('hidden');
        });

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const index = parseInt(document.getElementById('editIndex').value);
            const oldData = savedData[index];
            
            const processUpdate = (imageData, imageName) => {
                const newData = {
                    branchCode: document.getElementById('editBranchCode').value,
                    branchName: '‡∏™‡∏≤‡∏Ç‡∏≤' + document.getElementById('editBranchName').value,
                    district: document.getElementById('editDistrict').value,
                    ipAddress: document.getElementById('editIpAddress').value,
                    imageData: imageData,
                    imageName: imageName,
                    timestamp: oldData.timestamp
                };
                
                const branchCodePattern = /^[A-Za-z‡∏Å-‡∏Æ0-9]{2}$/;
                if (!branchCodePattern.test(newData.branchCode)) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ (A-Z, ‡∏Å-‡∏Æ, 0-9)');
                    return;
                }
                
                const ipPattern = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
                if (!ipPattern.test(newData.ipAddress)) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å IP Address ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    return;
                }
                
                if (savedData.some((item, i) => i !== index && item.branchCode === newData.branchCode)) {
                    alert('‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                    return;
                }
                
                let changes = [];
                if (oldData.branchCode !== newData.branchCode) changes.push(`‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤: ${oldData.branchCode} ‚Üí ${newData.branchCode}`);
                if (oldData.branchName !== newData.branchName) changes.push(`‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤: ${oldData.branchName} ‚Üí ${newData.branchName}`);
                if (oldData.district !== newData.district) changes.push(`‡πÄ‡∏Ç‡∏ï: ${oldData.district} ‚Üí ${newData.district}`);
                if (oldData.ipAddress !== newData.ipAddress) changes.push(`IP: ${oldData.ipAddress} ‚Üí ${newData.ipAddress}`);
                if (editFileInput.files[0]) changes.push('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ IP');
                
                savedData[index] = newData;
                saveDataPersistent();
                
                addLog('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', newData.branchCode, newData.branchName, changes.join(', '));
                
                document.getElementById('editModal').classList.add('hidden');
                editFileInput.value = '';
                editUploadContent.classList.remove('hidden');
                editImagePreview.classList.add('hidden');
                displayData();
                displayLogData();
                updateDashboard();
                
                alert('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
            };
            
            if (editFileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processUpdate(e.target.result, editFileInput.files[0].name);
                };
                reader.readAsDataURL(editFileInput.files[0]);
            } else {
                processUpdate(oldData.imageData, oldData.imageName);
            }
        });

        function deleteData(index) {
            const item = savedData[index];
            const password = prompt(`üîê ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ "${item.branchName}" (${item.branchCode}):`);
            
            if (password !== '348900Ty') {
                if (password !== null) {
                    alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                }
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ "${item.branchName}" (${item.branchCode})?\n\n‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ!`)) {
                return;
            }
            
            addLog('‡∏•‡∏ö', item.branchCode, item.branchName, `‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ IP: ${item.ipAddress}, ‡πÄ‡∏Ç‡∏ï: ${item.district}`);
            
            savedData.splice(index, 1);
            saveDataPersistent();
            
            displayData();
            displayLogData();
            updateDashboard();
            
            alert('‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
        }

        document.getElementById('downloadLogBtn').addEventListener('click', function() {
            if (logData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ Log ‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
                return;
            }
            
            const password = prompt('üîê ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Log Excel:');
            
            if (password !== '348900Ty') {
                if (password !== null) {
                    alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ');
                }
                return;
            }
            
            const excelLogData = logData.map(log => ({
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤': log.timestamp, '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ': log.user, '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥': log.action,
                '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤': log.branchCode, '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î': log.details
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelLogData);
            
            ws['!cols'] = [
                { width: 20 }, { width: 20 }, { width: 10 },
                { width: 15 }, { width: 50 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Log ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
            
            const now = new Date();
            const filename = `Log_‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            
            alert('‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Log ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
        });
        
        displayData();
        displayLogData();
        updateDashboard();
    </script>
</body>
</html>
